<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lilian Sweets - Nova Venda</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../public/css/style.css" />
</head>
<body>
  <nav class="nav-bar">
    <div class="div-nav-bar justify-content-between">
          <div class="d-flex flex-row">
              <div class="is-flex m-1">
                  <button id="menu-button" class="menu-button">
                      <img src="/public/images/icons/list.svg" alt="Ícone de lista">
                  </button>
              </div>

              <img class="img-logo" src="../public/images/logo_lilian.png" alt="Logo da Lilian Sweets">
              <p class="welcome-text">Bem-vinda <strong class="destaque">Lilian!</strong></p>
          </div>

          <div>
            <button class="btn btn-salvar mt-4 mr-4" onclick="logout()">Sair</button>
          </div>
        </div>
  </nav>

  <div class="side-bar">
    <a href="/index" class="side-bar-link">
      <img class="side-bar-icon" src="../public/images/icons/house.svg" alt="Ícone de uma casa" /> Início
    </a>
    <a href="/produtos" class="side-bar-link">
      <img class="side-bar-icon" src="../public/images/icons/cake.svg" alt="Ícone de um bolo" /> Produtos
    </a>
    <a href="/insumos" class="side-bar-link">
      <img class="side-bar-icon" src="../public/images/icons/minecart.svg" alt="Ícone de um carrinho" /> Insumos
    </a>
    <a href="#" class="side-bar-link">
      <img class="side-bar-icon" src="../public/images/icons/card-list.svg" alt="Ícone de uma lista" /> Cardápio
    </a>
    <a href="/vendas" class="side-bar-link">
      <img class="side-bar-icon" src="../public/images/icons/cash-coin.svg" alt="Ícone de dinheiro com moeda" /> Vendas
    </a>
    <a href="/estoque" class="side-bar-link">
      <img class="side-bar-icon" src="../public/images/icons/box-seam.svg" alt="Ícone de uma caixa de papelão" /> Estoque
    </a>
    <a href="/despesas" class="side-bar-link">
      <img class="side-bar-icon" src="../public/images/icons/credit-card.svg" alt="Ícone de uma caixa de papelão" /> Despesas
    </a>
    <a href="/cadastro-usuario" class="side-bar-link">
      <img class="side-bar-icon" src="../public/images/icons/person.svg" alt="Ícone de uma pessoa" /> Novo Usuário
    </a>
  </div>

  <main class="main-form is-flex">
    <div class="form-border">
      <p class="titulo-form">Nova venda</p>
      <form id="venda-form" action="">
        <div class="form-group container-form">
          <div class="form-row">

            <div class="is-flex container-label-input">
              <label for="nome" class="label-form">Nome do cliente</label>
              <input class="input-form form-control" type="name" id="nome-cliente" placeholder="Digite o nome do cliente" required  />
            </div>
           
            <div class="is-flex container-label-input">
                <label for="data-venda" class="label-form">Data entrega</label>
                <input class="input-form form-control" type="date" id="data-entrega" required />
            </div>

            <div class="is-flex container-label-input">
                <label for="tipo-entrega" class="label-form">Tipo de entrega</label>
                <select class="form-select input-form form-control" name="forma-pagamento" id="tipo-entrega" required>
                <option value="" disabled selected>Selecione</option>
                <option value="retirada">Retirada</option>
                <option value="entrega">Entrega</option>
               </select>
            </div>

            <div class="is-flex container-label-input">
                <label for="forma-pagamento" class="label-form">Forma de pagamento</label>
                <select class="form-select input-form form-control" name="forma-pagamento" id="forma-pagamento" required>
                <option value="" disabled selected>Selecione</option>
                <option value="pix">Pix</option>
                <option value="dinheiro">Dinheiro</option>
                <option value="credito">Cartão de crédito</option>
                <option value="debito">Cartão de débito</option>
               </select>
            </div>

          <div class="is-flex container-label-input">
              <label for="tipo-venda" class="label-form">Tipo de venda</label>
              <select class="form-select input-form form-control" name="tipo-venda" id="tipo-venda" required>
                <option value="" disabled selected>Selecione</option>
                <option value="encomenda">Encomenda</option>
                <option value="pronta-entrega">Pronta entrega</option>
              </select>
            </div>
          </div>


          <div class="is-flex container-label-input">
            <label for="produto" class="label-form">Produto</label>
            <select class="input-form form-control" name="produto" id="produto" multiple size="5" required>
              <option disabled>Selecione os produtos vendidos</option>
            </select>
            <small>Segure Ctrl (ou Cmd) para selecionar múltiplos produtos</small>
          </div>


            <div class="is-flex container-label-input">
              <label for="valor" class="label-form">Valor Total</label>
              <input
                class="input-form form-control mascara-valor"
                type="text"
                name="valor"
                id="valor"
                placeholder="R$ 0,00"
                readonly
                required
              />
            </div>
          </div>

          <div class="container-form-buttons is-flex is-gap-15">
            <button type="submit" class="btn btn-salvar btn-lg">Salvar</button>
            <button
              type="button"
              class="btn btn-outline-secondary btn-lg btn-cancel"
              onclick="limparECancelarForm('venda-form', 'vendas')"
            >
              Cancelar
            </button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <!-- JS Bootstrap e jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const produtoSelect = document.getElementById('produto');
    const valorInput = document.getElementById('valor');
    const vendaForm = document.getElementById('venda-form');
  
async function carregarProdutos() {
  try {
    const res = await fetch('/api/produtos');
    if (!res.ok) throw new Error('Erro ao buscar produtos');
    const produtos = await res.json();

    produtoSelect.innerHTML = '<option disabled>Selecione os produtos vendidos</option>';

    produtos.forEach((p) => {
      const valor = Number(p.valor);
      const quantidade = Number(p.quant_produzida);

      for (let i = 0; i < quantidade; i++) {
        const option = document.createElement('option');
        option.value = JSON.stringify({ nome: p.nome, descr: p.descr });
        option.textContent = `${p.nome} - ${p.descr} (R$ ${valor.toFixed(2)}) [${i + 1}]`;
        option.dataset.valor = valor;
        produtoSelect.appendChild(option);
      }
    });
  } catch (error) {
    console.error('Erro ao carregar produtos:', error);
    alert('Erro ao carregar produtos');
  }
}

function calcularValor() {
  let total = 0;

  for (const option of produtoSelect.selectedOptions) {
    const valorUnitario = parseFloat(option.dataset.valor) || 0;
    total += valorUnitario;
  }

  valorInput.value = total.toLocaleString('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  });
}

   produtoSelect.addEventListener('change', calcularValor);

   carregarProdutos();


    vendaForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const dataEntrega = document.getElementById('data-entrega').value;
      const formaPagamento = document.getElementById('forma-pagamento').value;
      const nomeCliente = document.getElementById('nome-cliente').value;
      const tipoVenda = document.getElementById('tipo-venda').value;
      const tipoEntrega = document.getElementById('tipo-entrega').value;
      const quantidade = Number(quantidadeInput.value);
      const produtosSelecionados = Array.from(produtoSelect.selectedOptions).map((opt) =>
        JSON.parse(opt.value)
      );

     if (!nomeCliente || !dataEntrega || !formaPagamento || !tipoVenda || !tipoEntrega|| produtosSelecionados.length === 0 || quantidade < 1) {
        alert('Preencha todos os campos corretamente.');
        return;
      }

        const dadosVenda = {
        nome_cliente: nomeCliente,
        forma_pagamento: formaPagamento,
        tipo_venda: tipoVenda,
        tipo_entrega: tipoEntrega,
        data_entrega: dataEntrega,
        quantidade,
        produtos: produtosSelecionados  
        };

      try {
        const res = await fetch('/api/vendas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dadosVenda),
        });

        if (!res.ok) throw new Error('Erro ao salvar venda');

        alert('Venda salva com sucesso!');
        vendaForm.reset();
        valorInput.value = 'R$ 0,00';
      } catch (error) {
        console.error(error);
        alert('Erro ao salvar venda. Tente novamente.');
      }
    });

    const menuBtn = document.getElementById('menu-button');
    const sidebar = document.querySelector('.side-bar');
    menuBtn.addEventListener('click', () => {
      sidebar.classList.toggle('active');
    });
});

window.onload = () => {
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login';
    }
  }
</script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="../public/scripts/mascaraMonetaria.js"></script>
  <script src="../../public/scripts/acoesForms.js"></script>
  <script src="../public/scripts/include.js" defer></script>
</body>
</html>
